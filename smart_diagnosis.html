<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šè¯è´¨é‡æ ‡æ³¨ç³»ç»Ÿ - æ™ºèƒ½è¯Šæ–­ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨CDN...');
                const script = document.createElement('script');
                script.src = 'https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
                script.onload = function() {
                    console.log('å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
                };
                script.onerror = function() {
                    console.error('å¤‡ç”¨CDNä¹ŸåŠ è½½å¤±è´¥');
                    alert('Chart.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                };
                document.head.appendChild(script);
            } else {
                console.log('Chart.js åŠ è½½æˆåŠŸ');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .config-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .toggle-btn:hover {
            background: #5568d3;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8edff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .results-header h2 {
            color: #333;
            font-size: 24px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 14px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
        }

        .download-btn.report {
            background: #17a2b8;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag-positive {
            background: #d4edda;
            color: #155724;
        }

        .tag-neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .tag-hesitant {
            background: #fff3cd;
            color: #856404;
        }

        .tag-impatient {
            background: #f8d7da;
            color: #721c24;
        }

        .tag-angry {
            background: #f5c6cb;
            color: #721c24;
        }

        .tag-intention-a {
            background: #d4edda;
            color: #155724;
        }

        .tag-intention-b {
            background: #cce5ff;
            color: #004085;
        }

        .tag-intention-c {
            background: #fff3cd;
            color: #856404;
        }

        .tag-intention-d {
            background: #f8d7da;
            color: #721c24;
        }

        .tag-intention-e {
            background: #e2e3e5;
            color: #383d41;
        }

        .tag-risk-high {
            background: #f8d7da;
            color: #721c24;
        }

        .tag-risk-low {
            background: #d4edda;
            color: #155724;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #721c24;
        }

        .error-message.show {
            display: block;
        }

        .selected-file {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #e8edff;
            border-radius: 10px;
            color: #333;
        }

        .selected-file.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #e8edff;
            color: #667eea;
            font-weight: 600;
        }

        .mode-btn:hover {
            border-color: #667eea;
        }

        .report-section {
            display: none;
            margin-top: 40px;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 20px;
        }

        .report-section.show {
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .report-header h2 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .report-header p {
            color: #666;
            font-size: 16px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .report-card h3 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .recommendation-item.warning {
            border-left-color: #ffc107;
            background: #fffde7;
        }

        .recommendation-item.danger {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .recommendation-item.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .recommendation-item h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .recommendation-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .insight-box h4 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .insight-box p {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-item .value {
            font-size: 28px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-item .label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é€šè¯è´¨é‡æ ‡æ³¨ç³»ç»Ÿ - æ™ºèƒ½è¯Šæ–­ç‰ˆ</h1>
            <p>æ”¯æŒè§„åˆ™å¼•æ“å’Œå¤§æ¨¡å‹AIï¼Œè‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–è¯Šæ–­æŠ¥å‘Šå’Œè¿è¥ä¼˜åŒ–å»ºè®®</p>
        </div>

        <div class="config-section">
            <div class="config-title">
                <span>âš™ï¸</span>
                <span>åˆ†ææ¨¡å¼é…ç½®</span>
            </div>
            
            <div class="mode-selector">
                <div class="mode-btn active" data-mode="rule" onclick="selectMode('rule')">
                    <strong>è§„åˆ™å¼•æ“</strong>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">åŸºäºå…³é”®è¯è§„åˆ™ï¼Œå¿«é€Ÿå‡†ç¡®</div>
                </div>
                <div class="mode-btn" data-mode="ai" onclick="selectMode('ai')">
                    <strong>å¤§æ¨¡å‹AI</strong>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">ä½¿ç”¨AIæ·±åº¦ç†è§£ï¼Œæ›´ç²¾å‡†</div>
                </div>
            </div>

            <div id="aiConfig" class="hidden">
                <div class="config-form">
                    <div class="form-group">
                        <label>APIæä¾›å•†</label>
                        <select id="apiProvider" onchange="updateProviderConfig()">
                            <option value="openai">OpenAI (GPT-4/GPT-3.5)</option>
                            <option value="zhipu">æ™ºè°±AI (GLM-4)</option>
                            <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„API Key">
                        <div class="hint">æ‚¨çš„API Keyä»…ç”¨äºè°ƒç”¨å¤§æ¨¡å‹ï¼Œä¸ä¼šä¿å­˜åˆ°æœåŠ¡å™¨</div>
                    </div>

                    <div class="form-group">
                        <label>APIåœ°å€</label>
                        <input type="text" id="apiEndpoint" placeholder="https://api.openai.com/v1/chat/completions">
                        <div class="hint">æ ¹æ®é€‰æ‹©çš„æä¾›å•†è‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯æ‰‹åŠ¨ä¿®æ”¹</div>
                    </div>

                    <div class="form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <input type="text" id="modelName" placeholder="gpt-4">
                        <div class="hint">ä¾‹å¦‚ï¼šgpt-4, gpt-3.5-turbo, glm-4, qwen-turbo</div>
                    </div>

                    <div class="form-group">
                        <label>æ¸©åº¦å‚æ•°</label>
                        <input type="number" id="temperature" value="0.3" min="0" max="2" step="0.1">
                        <div class="hint">0-2ä¹‹é—´ï¼Œå€¼è¶Šä½è¾“å‡ºè¶Šç¡®å®šï¼Œå€¼è¶Šé«˜è¾“å‡ºè¶Šéšæœº</div>
                    </div>

                    <div class="form-group">
                        <label>æœ€å¤§Tokenæ•°</label>
                        <input type="number" id="maxTokens" value="1000" min="100" max="4000" step="100">
                        <div class="hint">æ§åˆ¶ç”Ÿæˆå†…å®¹çš„é•¿åº¦</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <button class="toggle-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="toggle-btn" onclick="testConnection()" style="background: #28a745;">ğŸ” æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½CSV/Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ .csv å’Œ .xlsx æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 50MB</div>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                <div class="selected-file" id="selectedFile"></div>
                <button class="upload-btn" id="uploadBtn" disabled>å¼€å§‹åˆ†æ</button>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">æ­£åœ¨åˆ†æé€šè¯æ–‡æœ¬ï¼Œè¯·ç¨å€™...</p>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>æ ‡æ³¨ç»“æœ</h2>
                <div>
                    <button class="download-btn" id="downloadCsvBtn">ä¸‹è½½CSV</button>
                    <button class="download-btn" id="downloadExcelBtn" style="background: #217346;">ä¸‹è½½Excel</button>
                    <button class="download-btn report" id="downloadReportBtn">ğŸ“Š ä¸‹è½½è¯Šæ–­æŠ¥å‘Š</button>
                </div>
            </div>
            
            <div class="stats" id="statsSection">
            </div>
            
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>å•å·</th>
                            <th>æƒ…ç»ªæ€åº¦</th>
                            <th>ç»­ä¿æ„å‘</th>
                            <th>æ ¸å¿ƒå½’å› </th>
                            <th>é£é™©é¢„è­¦</th>
                            <th>ä¸€å¥è¯æ‘˜è¦</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="report-section" id="reportSection">
                <div class="report-header">
                    <h2>ğŸ“Š å¯è§†åŒ–è¯Šæ–­æŠ¥å‘Š</h2>
                    <p>åŸºäºé€šè¯è´¨é‡æ ‡æ³¨æ•°æ®çš„æ·±åº¦åˆ†æä¸è¿è¥ä¼˜åŒ–å»ºè®®</p>
                </div>

                <div class="report-grid">
                    <div class="report-card">
                        <h3>ğŸ“ˆ æƒ…ç»ªæ€åº¦åˆ†å¸ƒ</h3>
                        <div class="chart-container">
                            <canvas id="sentimentChart"></canvas>
                        </div>
                        <div class="metric-grid" id="sentimentMetrics"></div>
                    </div>

                    <div class="report-card">
                        <h3>ğŸ’¼ ç»­ä¿æ„å‘åˆ†å¸ƒ</h3>
                        <div class="chart-container">
                            <canvas id="intentionChart"></canvas>
                        </div>
                        <div class="metric-grid" id="intentionMetrics"></div>
                    </div>

                    <div class="report-card">
                        <h3>ğŸ¯ æ ¸å¿ƒå½’å› åˆ†æ</h3>
                        <div class="chart-container">
                            <canvas id="reasonChart"></canvas>
                        </div>
                        <div class="metric-grid" id="reasonMetrics"></div>
                    </div>

                    <div class="report-card">
                        <h3>âš ï¸ é£é™©é¢„è­¦åˆ†æ</h3>
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                        <div class="metric-grid" id="riskMetrics"></div>
                    </div>
                </div>

                <div class="report-card" style="margin-top: 30px;">
                    <h3>ğŸ’¡ å…³é”®æ´å¯Ÿ</h3>
                    <div id="insightsContainer"></div>
                </div>

                <div class="report-card" style="margin-top: 30px;">
                    <h3>ğŸ¯ è¿è¥ä¼˜åŒ–å»ºè®®</h3>
                    <ul class="recommendation-list" id="recommendationsContainer"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentMode = 'rule';
        let currentResults = [];
        let charts = {};
        let config = {
            provider: 'openai',
            apiKey: '',
            endpoint: 'https://api.openai.com/v1/chat/completions',
            model: 'gpt-4',
            temperature: 0.3,
            maxTokens: 1000
        };

        const providerConfigs = {
            openai: {
                endpoint: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-4',
                name: 'OpenAI'
            },
            zhipu: {
                endpoint: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                model: 'glm-4',
                name: 'æ™ºè°±AI'
            },
            qwen: {
                endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                model: 'qwen-turbo',
                name: 'é€šä¹‰åƒé—®'
            },
            deepseek: {
                endpoint: 'https://api.deepseek.com/chat/completions',
                model: 'deepseek-chat',
                name: 'DeepSeek'
            }
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const selectedFile = document.getElementById('selectedFile');
        const errorMessage = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');
        const statsSection = document.getElementById('statsSection');
        const reportSection = document.getElementById('reportSection');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');

        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            const aiConfig = document.getElementById('aiConfig');
            if (mode === 'ai') {
                aiConfig.classList.remove('hidden');
            } else {
                aiConfig.classList.add('hidden');
            }
        }

        function updateProviderConfig() {
            const provider = document.getElementById('apiProvider').value;
            const providerConfig = providerConfigs[provider];
            
            if (providerConfig) {
                document.getElementById('apiEndpoint').value = providerConfig.endpoint;
                document.getElementById('modelName').value = providerConfig.model;
            }
        }

        function saveConfig() {
            config = {
                provider: document.getElementById('apiProvider').value,
                apiKey: document.getElementById('apiKey').value,
                endpoint: document.getElementById('apiEndpoint').value,
                model: document.getElementById('modelName').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                maxTokens: parseInt(document.getElementById('maxTokens').value)
            };
            
            localStorage.setItem('callLabelerConfig', JSON.stringify(config));
            alert('é…ç½®å·²ä¿å­˜ï¼');
        }

        function loadConfig() {
            const saved = localStorage.getItem('callLabelerConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiProvider').value = config.provider;
                document.getElementById('apiKey').value = config.apiKey;
                document.getElementById('apiEndpoint').value = config.endpoint;
                document.getElementById('modelName').value = config.model;
                document.getElementById('temperature').value = config.temperature;
                document.getElementById('maxTokens').value = config.maxTokens;
            }
        }

        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const endpoint = document.getElementById('apiEndpoint').value;
            const model = document.getElementById('modelName').value;

            if (!apiKey) {
                alert('è¯·å…ˆè¾“å…¥API Key');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'ä½ å¥½' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    alert('è¿æ¥æˆåŠŸï¼APIé…ç½®æ­£ç¡®ã€‚');
                } else {
                    const error = await response.json();
                    alert(`è¿æ¥å¤±è´¥ï¼š${error.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`è¿æ¥å¤±è´¥ï¼š${error.message}`);
            }
        }

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const validExtensions = ['.csv', '.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!validExtensions.includes(fileExtension)) {
                showError('è¯·ä¸Šä¼ CSVæˆ–Excelæ–‡ä»¶ï¼ˆ.csvã€.xlsx æˆ– .xls æ ¼å¼ï¼‰');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 50MB');
                return;
            }

            hideError();
            selectedFile.textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`;
            selectedFile.classList.add('show');
            uploadBtn.disabled = false;
            uploadBtn.onclick = () => processFile(file);
        }

        function processFile(file) {
            uploadBtn.disabled = true;
            loading.classList.add('show');
            resultsSection.classList.remove('show');
            reportSection.classList.remove('show');
            hideError();

            const reader = new FileReader();

            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => {
                    const text = e.target.result;
                    const data = parseCSV(text);
                    analyzeData(data);
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    analyzeData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }

            return data;
        }

        async function analyzeData(data) {
            try {
                currentResults = [];

                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    const textColumn = row['é€šè¯æ–‡æœ¬'] || row['text'] || row['å†…å®¹'] || row['content'];
                    const callId = row['å•å·'] || row['id'] || row['ID'] || (i + 1).toString();

                    if (textColumn) {
                        let result;
                        if (currentMode === 'ai') {
                            result = await analyzeWithAI(textColumn, callId);
                        } else {
                            result = analyzeWithRules(textColumn, callId);
                        }
                        currentResults.push(result);
                    }

                    const progress = Math.round(((i + 1) / data.length) * 100);
                    progressFill.textContent = `${progress}%`;
                    progressFill.style.width = `${progress}%`;
                    loadingText.textContent = `æ­£åœ¨åˆ†æç¬¬ ${i + 1}/${data.length} æ¡è®°å½•...`;
                }

                if (currentResults.length > 0) {
                    displayResults(currentResults);
                    displayStats(currentResults);
                    resultsSection.classList.add('show');
                    reportSection.classList.add('show');
                    
                    if (typeof Chart === 'undefined') {
                        loadingText.textContent = 'æ­£åœ¨åŠ è½½å›¾è¡¨åº“...';
                        setTimeout(() => generateReport(currentResults), 1000);
                    } else {
                        generateReport(currentResults);
                    }
                } else {
                    showError('æ— æ³•è§£ææ–‡ä»¶æˆ–ç¼ºå°‘é€šè¯æ–‡æœ¬åˆ—');
                }
            } catch (error) {
                showError('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
            } finally {
                loading.classList.remove('show');
                uploadBtn.disabled = false;
            }
        }

        async function analyzeWithAI(text, callId) {
            const prompt = `è¯·åˆ†æä»¥ä¸‹é€šè¯æ–‡æœ¬ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ ‡å‡†è¿›è¡Œæ ‡æ³¨ï¼š

é€šè¯æ–‡æœ¬ï¼š
${text}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¿”å›JSONç»“æœï¼š
{
  "æƒ…ç»ªæ€åº¦": "ç§¯æ/å¹³æ·¡/çŠ¹è±«/ä¸è€çƒ¦/æ„¤æ€’",
  "ç»­ä¿æ„å‘": "Aç±»-æ‰¿è¯ºç¼´è´¹/Bç±»-éœ€ååŠ©/Cç±»-æ‘‡æ‘†ä¸å®š/Dç±»-æ˜ç¡®æ‹’ç¼´/Eç±»-æ— æ•ˆ/éæœ¬äºº",
  "æ ¸å¿ƒå½’å› ": "ç»æµå‹åŠ›/äº§å“ä¸æ»¡/æœåŠ¡ä¸æ»¡/æ“ä½œéšœç¢/ç«å“æµå¤±/ä¿¡æ¯è§¦è¾¾/æ— ",
  "é£é™©é¢„è­¦": "é«˜/ä½",
  "ä¸€å¥è¯æ‘˜è¦": "å®¢æˆ·æ ¸å¿ƒè§‚ç‚¹ï¼ˆ10å­—ä»¥å†…ï¼‰"
}

æ ‡æ³¨æ ‡å‡†ï¼š
- æƒ…ç»ªæ€åº¦ï¼šç§¯æï¼ˆé…åˆæ²Ÿé€šã€è¯¢é—®ç»†èŠ‚ã€æ€åº¦æ¸©å’Œï¼‰ã€å¹³æ·¡ï¼ˆæœºæ¢°å›ç­”ã€æ— æ˜æ˜¾æƒ…ç»ªã€ä»…è¯´"ä½ å¥½/å–‚"ï¼‰ã€çŠ¹è±«ï¼ˆè¯´"å†çœ‹çœ‹"ã€"è€ƒè™‘ä¸€ä¸‹"ã€"è¿˜æ²¡å®š"ï¼‰ã€ä¸è€çƒ¦ï¼ˆè¯´"æˆ‘å¾ˆå¿™"ã€"å¼€ä¼š"ã€"åˆ«æ‰“äº†"ã€"çƒ¦ä¸çƒ¦"ï¼‰ã€æ„¤æ€’ï¼ˆè¾±éª‚ã€å¨èƒæŠ•è¯‰ã€æƒ…ç»ªæ¿€åŠ¨ï¼‰
- ç»­ä¿æ„å‘ï¼šAç±»-æ‰¿è¯ºç¼´è´¹ï¼ˆæ˜ç¡®ç­”åº”äº¤é’±ã€é—®åœ¨å“ªé‡Œäº¤ï¼‰ã€Bç±»-éœ€ååŠ©ï¼ˆä¸ä¼šæ“ä½œã€å¡æœ‰é—®é¢˜ã€éœ€è¦å¸®åŠ©ï¼‰ã€Cç±»-æ‘‡æ‘†ä¸å®šï¼ˆè€ƒè™‘ä¸­ã€éœ€è¦å†è€ƒè™‘ã€å•†é‡ä¸€ä¸‹ï¼‰ã€Dç±»-æ˜ç¡®æ‹’ç¼´ï¼ˆæ˜ç¡®è¯´"ä¸äº¤äº†"ã€"ä¸è¦äº†"ã€"é€€ä¿"ï¼‰ã€Eç±»-æ— æ•ˆ/éæœ¬äººï¼ˆæ‰“é”™ç”µè¯ã€ä¸æ˜¯æœ¬äººã€åªæœ‰"å–‚"å£°æ— ä¸‹æ–‡ï¼‰
- æ ¸å¿ƒå½’å› ï¼šç»æµå‹åŠ›ï¼ˆæ²¡é’±ã€å¤±ä¸šã€å¤ªè´µã€åƒé¥­éƒ½æˆé—®é¢˜ï¼‰ã€äº§å“ä¸æ»¡ï¼ˆæ”¶ç›Šä½ã€è§‰å¾—è¢«éª—ã€æƒ³é€€ä¿ï¼‰ã€æœåŠ¡ä¸æ»¡ï¼ˆç†èµ”éš¾ã€æ‰“ä¸é€šã€æœåŠ¡å·®ï¼‰ã€æ“ä½œéšœç¢ï¼ˆä¸ä¼šæ“ä½œã€å¡æœ‰é—®é¢˜ã€æ‰¾ä¸åˆ°å…¥å£ï¼‰ã€ç«å“æµå¤±ï¼ˆä¹°äº†åˆ«å®¶äº§å“ï¼‰ã€ä¿¡æ¯è§¦è¾¾ï¼ˆä¸çŸ¥é“è¦äº¤ã€ä»¥ä¸ºå·²ç»äº¤äº†ï¼‰ã€æ— ï¼ˆæ­£å¸¸æ²Ÿé€šæˆ–æœªæ¥é€šï¼Œæ— æŠ—æ‹’ç‚¹ï¼‰
- é£é™©é¢„è­¦ï¼šé«˜ï¼ˆæåˆ°æŠ•è¯‰ã€é“¶ä¿ç›‘ã€æŠ¥è­¦ã€éªšæ‰°ã€ä¸å†æ¥å¬ï¼‰ã€ä½ï¼ˆæ— ä¸Šè¿°æ•æ„Ÿè¯ï¼‰

ä¸€å¥è¯æ‘˜è¦è¦æ±‚ï¼š
- æç‚¼å®¢æˆ·çš„æ ¸å¿ƒè¯‰æ±‚æˆ–æ ¸å¿ƒè§‚ç‚¹ï¼Œä¸è¦ç®€å•æˆªå–å¯¹è¯å¼€å¤´
- ä¸¥æ ¼æ§åˆ¶åœ¨10ä¸ªå­—ä»¥å†…
- ç¤ºä¾‹ï¼š
  * "å“å‘€æˆ‘ç°åœ¨é¥­éƒ½åƒä¸èµ·äº†ï¼Œå“ªé‡Œè¿˜æœ‰é’±äº¤ä¿è´¹å•Šï¼Œåˆ«æ‰“äº†" â†’ "æ²¡é’±åƒé¥­åˆ«æ‰“äº†"
  * "æˆ‘ç°åœ¨æ­£åœ¨å¼€ä¼šï¼Œä¸æ–¹ä¾¿æ¥ç”µè¯" â†’ "æ­£åœ¨å¼€ä¼šä¸æ–¹ä¾¿"
  * "è¿™ä¸ªä¿é™©æˆ‘ä¸éœ€è¦äº†ï¼Œå·²ç»ä¹°äº†åˆ«å®¶çš„" â†’ "ä¸éœ€è¦å·²ä¹°åˆ«å®¶"
  * "æˆ‘è€ƒè™‘ä¸€ä¸‹ï¼Œè¿‡å‡ å¤©å†ç»™ä½ ç­”å¤" â†’ "è€ƒè™‘ä¸€ä¸‹è¿‡å‡ å¤©"
  * "æˆ‘ä¸ä¼šæ“ä½œæ‰‹æœºï¼Œèƒ½ä¸èƒ½å¸®æˆ‘äº¤ä¸€ä¸‹" â†’ "ä¸ä¼šæ“ä½œå¸®äº¤"
  * "æ‰“é”™äº†ï¼Œæˆ‘ä¸æ˜¯ä½ è¦æ‰¾çš„äºº" â†’ "æ‰“é”™ä¸æ˜¯æœ¬äºº"

è¯·åªè¿”å›JSONï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚`;

            console.log('å¼€å§‹AIåˆ†æï¼Œå•å·:', callId);
            console.log('APIç«¯ç‚¹:', config.endpoint);
            console.log('æ¨¡å‹:', config.model);
            console.log('API Keyå‰4ä½:', config.apiKey ? config.apiKey.substring(0, 4) + '***' : 'æœªè®¾ç½®');

            try {
                const response = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: config.temperature,
                        max_tokens: config.maxTokens
                    })
                });

                console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}`;
                    console.error('APIé”™è¯¯è¯¦æƒ…:', errorData);
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${errorMessage}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    console.log('AIåˆ†ææˆåŠŸ:', result);
                    return {
                        'å•å·': callId,
                        'æƒ…ç»ªæ€åº¦': result.æƒ…ç»ªæ€åº¦,
                        'ç»­ä¿æ„å‘': result.ç»­ä¿æ„å‘,
                        'æ ¸å¿ƒå½’å› ': result.æ ¸å¿ƒå½’å› ,
                        'é£é™©é¢„è­¦': result.é£é™©é¢„è­¦,
                        'ä¸€å¥è¯æ‘˜è¦': result.ä¸€å¥è¯æ‘˜è¦
                    };
                } else {
                    throw new Error('æ— æ³•è§£æAIè¿”å›çš„ç»“æœ');
                }
            } catch (error) {
                console.error('AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™å¼•æ“:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                return analyzeWithRules(text, callId);
            }
        }

        function analyzeWithRules(text, callId) {
            return {
                'å•å·': callId,
                'æƒ…ç»ªæ€åº¦': analyzeSentiment(text),
                'ç»­ä¿æ„å‘': analyzeIntention(text),
                'æ ¸å¿ƒå½’å› ': analyzeReason(text),
                'é£é™©é¢„è­¦': analyzeRisk(text),
                'ä¸€å¥è¯æ‘˜è¦': generateSummary(text)
            };
        }

        function analyzeSentiment(text) {
            const positiveKeywords = ['å¥½çš„', 'å¯ä»¥', 'æ²¡é—®é¢˜', 'æ„¿æ„', 'åŒæ„', 'è°¢è°¢', 'è¡Œ', 'å¯ä»¥å¯ä»¥', 'æ²¡é—®é¢˜æ²¡é—®é¢˜', 'é…åˆ', 'å¥½çš„å¥½çš„'];
            const hesitantKeywords = ['è€ƒè™‘', 'æƒ³æƒ³', 'çŠ¹è±«', 'ä¸å¤ªç¡®å®š', 'å†è¯´', 'å†è€ƒè™‘', 'å†æƒ³æƒ³', 'ä¸ç¡®å®š', 'å†çœ‹çœ‹', 'è¿˜æ²¡å®š', 'å•†é‡ä¸€ä¸‹'];
            const impatientKeywords = ['æˆ‘å¾ˆå¿™', 'å¼€ä¼š', 'åˆ«æ‰“äº†', 'çƒ¦ä¸çƒ¦', 'å¿«ç‚¹', 'æ²¡æ—¶é—´', 'æŒ‚äº†', 'ä¸æƒ³å¬', 'åˆ«è¯´äº†', 'æ²¡ç©º', 'åœ¨å¿™'];
            const angryKeywords = ['æŠ•è¯‰', 'é“¶ä¿ç›‘', 'æŠ¥è­¦', 'éªšæ‰°', 'ä¸å†æ¥å¬', 'éª—å­', 'æ»š', 'ä»–å¦ˆ', 'å¦ˆçš„', 'å‚»', 'ç¥ç»ç—…', 'å»æ­»', 'åƒåœ¾', 'å¨èƒ', 'èµ·è¯‰'];

            for (const keyword of angryKeywords) {
                if (text.includes(keyword)) return 'æ„¤æ€’';
            }
            for (const keyword of impatientKeywords) {
                if (text.includes(keyword)) return 'ä¸è€çƒ¦';
            }
            for (const keyword of hesitantKeywords) {
                if (text.includes(keyword)) return 'çŠ¹è±«';
            }
            for (const keyword of positiveKeywords) {
                if (text.includes(keyword)) return 'ç§¯æ';
            }

            return 'å¹³æ·¡';
        }

        function analyzeIntention(text) {
            const intentionA = ['ä¼šäº¤', 'è¦äº¤', 'æ„¿æ„äº¤', 'é©¬ä¸Šäº¤', 'ç°åœ¨äº¤', 'ç»™æˆ‘è´¦å·', 'è´¦å·å¤šå°‘', 'æ€ä¹ˆäº¤', 'ä»€ä¹ˆæ—¶å€™äº¤', 'åœ¨å“ªé‡Œäº¤', 'äº¤é’±', 'å»äº¤'];
            const intentionB = ['æƒ³äº¤', 'è¦äº¤ä½†', 'æƒ³äº¤ä½†', 'å¡ä¸è¡Œ', 'æ²¡é’±äº¤', 'ä¸ä¼šäº¤', 'å¸®æˆ‘äº¤', 'æ•™æˆ‘äº¤', 'å¸®æˆ‘æ“ä½œ', 'ä¸ä¼šæ“ä½œ', 'å¡æœ‰é—®é¢˜', 'éœ€è¦ååŠ©'];
            const intentionC = ['è€ƒè™‘', 'æƒ³æƒ³', 'å†çœ‹çœ‹', 'æ¯”è¾ƒ', 'å¯¹æ¯”', 'å†è€ƒè™‘', 'å†æƒ³æƒ³', 'ä¸ç¡®å®š', 'è¿˜æ²¡å†³å®š', 'éœ€è¦å†è€ƒè™‘', 'å•†é‡ä¸€ä¸‹'];
            const intentionD = ['ä¸äº¤', 'ä¸ç»­', 'ä¸ä¹°', 'ä¸ç»­ä¿', 'ä¸ç»­è´¹', 'ä¸äº¤äº†', 'ä¸ç»­äº†', 'é€€ä¿', 'ä¸è¦äº†', 'ä¸æƒ³è¦', 'ä¸åŠäº†', 'æ²¡é’±', 'ä¹°äº†', 'å·²ç»ä¹°äº†', 'åˆ«å®¶ä¹°äº†'];
            const intentionE = ['æ‰“é”™äº†', 'ä¸æ˜¯æœ¬äºº', 'æ‰¾é”™äººäº†', 'ä¸æ˜¯æˆ‘çš„', 'æˆ‘ä¸å«', 'ä½ æ‰“é”™äº†', 'æ‰“é”™ç”µè¯', 'ç©ºå·', 'åœæœº', 'å…³æœº', 'æœºå™¨åº”ç­”', 'åªæœ‰å–‚å£°'];

            for (const keyword of intentionA) {
                if (text.includes(keyword)) return 'Aç±»-æ‰¿è¯ºç¼´è´¹';
            }
            for (const keyword of intentionB) {
                if (text.includes(keyword)) return 'Bç±»-éœ€ååŠ©';
            }
            for (const keyword of intentionC) {
                if (text.includes(keyword)) return 'Cç±»-æ‘‡æ‘†ä¸å®š';
            }
            for (const keyword of intentionD) {
                if (text.includes(keyword)) return 'Dç±»-æ˜ç¡®æ‹’ç¼´';
            }
            for (const keyword of intentionE) {
                if (text.includes(keyword)) return 'Eç±»-æ— æ•ˆ/éæœ¬äºº';
            }

            return 'Cç±»-æ‘‡æ‘†ä¸å®š';
        }

        function analyzeReason(text) {
            const reasonEconomic = ['æ²¡é’±', 'æ²¡é’±äº¤', 'æ²¡é’±ç»­', 'å¤±ä¸š', 'æ²¡å·¥ä½œ', 'ç»æµ', 'å‹åŠ›å¤§', 'å¤ªè´µ', 'è´Ÿæ‹…', 'äº¤ä¸èµ·', 'ç»­ä¸èµ·'];
            const reasonProduct = ['æ”¶ç›Šä½', 'æ”¶ç›Šå·®', 'ä¸åˆ’ç®—', 'äºäº†', 'è¢«éª—', 'ä¸å¥½', 'ä¸æ»¡æ„', 'æ²¡ç”¨', 'æ²¡æ•ˆæœ'];
            const reasonService = ['ç†èµ”éš¾', 'æ²¡äººæ¥', 'æ‰“ä¸é€š', 'æœåŠ¡å·®', 'æ€åº¦å·®', 'æ²¡äººç®¡', 'æ‰¾ä¸åˆ°äºº', 'è”ç³»ä¸ä¸Š'];
            const reasonOperation = ['ä¸ä¼š', 'ä¸æ‡‚', 'å¿˜äº†å¯†ç ', 'å¡ä¸è¡Œ', 'é“¶è¡Œå¡', 'æ“ä½œ', 'ä¸ä¼šç”¨', 'è€äºº', 'ä¸ä¼šå¼„'];
            const reasonCompetitor = ['ä¹°äº†', 'åˆ«å®¶', 'å…¶ä»–å…¬å¸', 'å…¶ä»–ä¿é™©', 'åˆ«çš„ä¿é™©', 'å·²ç»ä¹°äº†', 'åœ¨åˆ«å¤„ä¹°äº†'];
            const reasonInfo = ['ä¸çŸ¥é“', 'æ²¡æ”¶åˆ°', 'æ²¡é€šçŸ¥', 'ä»¥ä¸ºäº¤äº†', 'ä»¥ä¸ºç»­äº†', 'ä¸çŸ¥é“è¦äº¤', 'ä¸çŸ¥é“è¦ç»­'];

            for (const keyword of reasonEconomic) {
                if (text.includes(keyword)) return 'ç»æµå‹åŠ›';
            }
            for (const keyword of reasonProduct) {
                if (text.includes(keyword)) return 'äº§å“ä¸æ»¡';
            }
            for (const keyword of reasonService) {
                if (text.includes(keyword)) return 'æœåŠ¡ä¸æ»¡';
            }
            for (const keyword of reasonOperation) {
                if (text.includes(keyword)) return 'æ“ä½œéšœç¢';
            }
            for (const keyword of reasonCompetitor) {
                if (text.includes(keyword)) return 'ç«å“æµå¤±';
            }
            for (const keyword of reasonInfo) {
                if (text.includes(keyword)) return 'ä¿¡æ¯è§¦è¾¾';
            }

            return 'æ— ';
        }

        function analyzeRisk(text) {
            const highRiskKeywords = ['æŠ•è¯‰', 'é“¶ä¿ç›‘', 'æŠ¥è­¦', 'éªšæ‰°', 'ä¸å†æ¥å¬', 'å½•éŸ³', 'éª—å­', 'è¯ˆéª—', 'è­¦å¯Ÿ', 'èµ·è¯‰', 'æ³•é™¢', 'å¾‹å¸ˆ', 'å¨èƒ', 'ä¸¾æŠ¥', 'æ›å…‰'];

            for (const keyword of highRiskKeywords) {
                if (text.includes(keyword)) return 'é«˜';
            }

            return 'ä½';
        }

        function generateSummary(text) {
            const patterns = [
                { summary: 'æ²¡é’±ä¸äº¤', regex: /(æ²¡é’±|äº¤ä¸èµ·|æ²¡é’±çš„|æ²¡é’±äº†).*?(ä¸äº¤|ä¸ç»­|ä¸ä¹°)/i },
                { summary: 'æ²¡é’±äº¤', regex: /æ²¡é’±.*?äº¤/i },
                { summary: 'ä¸äº¤äº†', regex: /(ä¸äº¤äº†|ä¸ç»­äº†|ä¸ä¹°äº†)/i },
                { summary: 'ä¸è¦äº†', regex: /(ä¸è¦äº†|ä¸æƒ³è¦äº†|ä¸åŠäº†)/i },
                { summary: 'é€€ä¿', regex: /é€€ä¿/i },
                { summary: 'æ­£åœ¨å¼€ä¼š', regex: /(æ­£åœ¨å¼€ä¼š|åœ¨å¼€ä¼š)/i },
                { summary: 'åœ¨å¿™', regex: /(åœ¨å¿™|å¾ˆå¿™|å¿™)/i },
                { summary: 'å¼€è½¦', regex: /(å¼€è½¦|åœ¨å¼€è½¦)/i },
                { summary: 'ä¸æ–¹ä¾¿', regex: /ä¸æ–¹ä¾¿/i },
                { summary: 'ä¸éœ€è¦', regex: /(ä¸éœ€è¦|æ²¡éœ€æ±‚)/i },
                { summary: 'æ²¡å…´è¶£', regex: /(æ²¡å…´è¶£|ä¸æ„Ÿå…´è¶£)/i },
                { summary: 'å·²ç»äº¤äº†', regex: /(å·²ç»äº¤äº†|äº¤è¿‡äº†)/i },
                { summary: 'å·²ç»ä¹°äº†', regex: /(å·²ç»ä¹°äº†|ä¹°å¥½äº†)/i },
                { summary: 'å·²ç»ç»­äº†', regex: /(å·²ç»ç»­äº†|ç»­è¿‡äº†)/i },
                { summary: 'è€ƒè™‘ä¸€ä¸‹', regex: /è€ƒè™‘/i },
                { summary: 'å†çœ‹çœ‹', regex: /å†çœ‹çœ‹/i },
                { summary: 'å•†é‡ä¸€ä¸‹', regex: /å•†é‡/i },
                { summary: 'ä¸ä¼šæ“ä½œ', regex: /(ä¸ä¼šæ“ä½œ|ä¸ä¼šå¼„|ä¸ä¼šç”¨)/i },
                { summary: 'å¡æœ‰é—®é¢˜', regex: /(å¡ä¸è¡Œ|å¡æœ‰é—®é¢˜|é“¶è¡Œå¡)/i },
                { summary: 'æ‰“é”™äº†', regex: /æ‰“é”™/i },
                { summary: 'ä¸æ˜¯æœ¬äºº', regex: /ä¸æ˜¯æœ¬äºº/i },
                { summary: 'æ‰¾é”™äºº', regex: /æ‰¾é”™/i },
                { summary: 'æŠ•è¯‰', regex: /æŠ•è¯‰/i },
                { summary: 'æŠ¥è­¦', regex: /æŠ¥è­¦/i },
                { summary: 'éªšæ‰°', regex: /éªšæ‰°/i },
                { summary: 'ä¸å†æ¥å¬', regex: /ä¸å†æ¥å¬/i }
            ];

            for (const pattern of patterns) {
                if (pattern.regex.test(text)) {
                    return pattern.summary;
                }
            }

            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ\n]/);
            const validSentences = sentences.filter(s => {
                const trimmed = s.trim();
                return trimmed.length >= 2 && trimmed.length <= 30;
            });

            if (validSentences.length === 0) return 'æ— ';

            const customerStatements = validSentences.filter(s => {
                const trimmed = s.trim();
                const hasCustomerKeyword = /^(æˆ‘|ä¸|æ²¡|å·²|è¦|æƒ³|åœ¨|æ­£|æ‰“|æ‰¾|ä¸)/.test(trimmed);
                return hasCustomerKeyword;
            });

            const statementsToUse = customerStatements.length > 0 ? customerStatements : validSentences;
            
            const shortest = statementsToUse.reduce((a, b) => a.length < b.length ? a : b);
            const cleaned = shortest.trim();

            if (cleaned.length <= 10) {
                return cleaned;
            }

            return cleaned.substring(0, 10);
        }

        function displayResults(results) {
            resultsBody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.å•å·}</td>
                    <td><span class="tag ${getSentimentClass(result.æƒ…ç»ªæ€åº¦)}">${result.æƒ…ç»ªæ€åº¦}</span></td>
                    <td><span class="tag ${getIntentionClass(result.ç»­ä¿æ„å‘)}">${result.ç»­ä¿æ„å‘}</span></td>
                    <td>${result.æ ¸å¿ƒå½’å› }</td>
                    <td><span class="tag ${getRiskClass(result.é£é™©é¢„è­¦)}">${result.é£é™©é¢„è­¦}</span></td>
                    <td>${result.ä¸€å¥è¯æ‘˜è¦}</td>
                `;
                resultsBody.appendChild(row);
            });
        }

        function displayStats(results) {
            const stats = {
                total: results.length,
                positive: results.filter(r => r.æƒ…ç»ªæ€åº¦ === 'ç§¯æ').length,
                angry: results.filter(r => r.æƒ…ç»ªæ€åº¦ === 'æ„¤æ€’').length,
                highRisk: results.filter(r => r.é£é™©é¢„è­¦ === 'é«˜').length,
                intentionA: results.filter(r => r.ç»­ä¿æ„å‘ === 'Aç±»-æ‰¿è¯ºç¼´è´¹').length,
                intentionD: results.filter(r => r.ç»­ä¿æ„å‘ === 'Dç±»-æ˜ç¡®æ‹’ç¼´').length
            };

            statsSection.innerHTML = `
                <div class="stat-card">
                    <h3>${stats.total}</h3>
                    <p>æ€»è®°å½•æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.positive}</h3>
                    <p>ç§¯ææ€åº¦</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.angry}</h3>
                    <p>æ„¤æ€’æ€åº¦</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.highRisk}</h3>
                    <p>é«˜é£é™©</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.intentionA}</h3>
                    <p>æ‰¿è¯ºç¼´è´¹</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.intentionD}</h3>
                    <p>æ˜ç¡®æ‹’ç¼´</p>
                </div>
            `;
        }

        function generateReport(results) {
            const sentimentData = analyzeSentimentDistribution(results);
            const intentionData = analyzeIntentionDistribution(results);
            const reasonData = analyzeReasonDistribution(results);
            const riskData = analyzeRiskDistribution(results);

            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                setTimeout(() => generateReport(results), 500);
                return;
            }

            createSentimentChart(sentimentData);
            createIntentionChart(intentionData);
            createReasonChart(reasonData);
            createRiskChart(riskData);

            generateInsights(results, sentimentData, intentionData, reasonData, riskData);
            generateRecommendations(results, sentimentData, intentionData, reasonData, riskData);
        }

        function analyzeSentimentDistribution(results) {
            const distribution = {};
            results.forEach(r => {
                distribution[r.æƒ…ç»ªæ€åº¦] = (distribution[r.æƒ…ç»ªæ€åº¦] || 0) + 1;
            });
            return distribution;
        }

        function analyzeIntentionDistribution(results) {
            const distribution = {};
            results.forEach(r => {
                distribution[r.ç»­ä¿æ„å‘] = (distribution[r.ç»­ä¿æ„å‘] || 0) + 1;
            });
            return distribution;
        }

        function analyzeReasonDistribution(results) {
            const distribution = {};
            results.forEach(r => {
                distribution[r.æ ¸å¿ƒå½’å› ] = (distribution[r.æ ¸å¿ƒå½’å› ] || 0) + 1;
            });
            return distribution;
        }

        function analyzeRiskDistribution(results) {
            const distribution = {};
            results.forEach(r => {
                distribution[r.é£é™©é¢„è­¦] = (distribution[r.é£é™©é¢„è­¦] || 0) + 1;
            });
            return distribution;
        }

        function createSentimentChart(data) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (charts.sentiment) {
                charts.sentiment.destroy();
            }

            charts.sentiment = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#d4edda',
                            '#e2e3e5',
                            '#fff3cd',
                            '#f8d7da',
                            '#f5c6cb'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            document.getElementById('sentimentMetrics').innerHTML = generateMetrics(data);
        }

        function createIntentionChart(data) {
            const ctx = document.getElementById('intentionChart').getContext('2d');
            
            if (charts.intention) {
                charts.intention.destroy();
            }

            charts.intention = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'æ•°é‡',
                        data: Object.values(data),
                        backgroundColor: [
                            '#d4edda',
                            '#cce5ff',
                            '#fff3cd',
                            '#f8d7da',
                            '#e2e3e5'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            document.getElementById('intentionMetrics').innerHTML = generateMetrics(data);
        }

        function createReasonChart(data) {
            const ctx = document.getElementById('reasonChart').getContext('2d');
            
            if (charts.reason) {
                charts.reason.destroy();
            }

            charts.reason = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#ffc107',
                            '#dc3545',
                            '#17a2b8',
                            '#28a745',
                            '#6610f2',
                            '#6c757d',
                            '#e9ecef'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            document.getElementById('reasonMetrics').innerHTML = generateMetrics(data);
        }

        function createRiskChart(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (charts.risk) {
                charts.risk.destroy();
            }

            charts.risk = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#f8d7da',
                            '#d4edda'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            document.getElementById('riskMetrics').innerHTML = generateMetrics(data);
        }

        function generateMetrics(data) {
            const total = Object.values(data).reduce((a, b) => a + b, 0);
            return Object.entries(data).map(([key, value]) => `
                <div class="metric-item">
                    <div class="value">${value}</div>
                    <div class="label">${key}</div>
                </div>
            `).join('');
        }

        function generateInsights(results, sentimentData, intentionData, reasonData, riskData) {
            const total = results.length;
            const insights = [];

            const positiveRate = ((sentimentData['ç§¯æ'] || 0) / total * 100).toFixed(1);
            const angryRate = ((sentimentData['æ„¤æ€’'] || 0) / total * 100).toFixed(1);
            const highRiskRate = ((riskData['é«˜'] || 0) / total * 100).toFixed(1);
            const intentionARate = ((intentionData['Aç±»-æ‰¿è¯ºç¼´è´¹'] || 0) / total * 100).toFixed(1);
            const intentionDRate = ((intentionData['Dç±»-æ˜ç¡®æ‹’ç¼´'] || 0) / total * 100).toFixed(1);

            if (positiveRate > 60) {
                insights.push({
                    type: 'success',
                    title: 'å®¢æˆ·æ»¡æ„åº¦é«˜',
                    content: `ç§¯ææ€åº¦å æ¯”è¾¾åˆ°${positiveRate}%ï¼Œè¯´æ˜å®¢æˆ·æ•´ä½“æ»¡æ„åº¦è¾ƒé«˜ï¼ŒæœåŠ¡æ•ˆæœè‰¯å¥½ã€‚`
                });
            } else if (positiveRate < 30) {
                insights.push({
                    type: 'warning',
                    title: 'å®¢æˆ·æ»¡æ„åº¦åä½',
                    content: `ç§¯ææ€åº¦å æ¯”ä»…ä¸º${positiveRate}%ï¼Œå»ºè®®ä¼˜åŒ–æœåŠ¡æµç¨‹ï¼Œæå‡å®¢æˆ·ä½“éªŒã€‚`
                });
            }

            if (angryRate > 5) {
                insights.push({
                    type: 'danger',
                    title: 'æ„¤æ€’æƒ…ç»ªåé«˜',
                    content: `æ„¤æ€’æƒ…ç»ªå æ¯”è¾¾åˆ°${angryRate}%ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å®¢æˆ·æŠ•è¯‰å’Œä¸æ»¡æƒ…ç»ªã€‚`
                });
            }

            if (highRiskRate > 3) {
                insights.push({
                    type: 'danger',
                    title: 'é«˜é£é™©å®¢æˆ·è¾ƒå¤š',
                    content: `é«˜é£é™©é¢„è­¦å æ¯”è¾¾åˆ°${highRiskRate}%ï¼Œå»ºè®®å»ºç«‹é£é™©é¢„è­¦æœºåˆ¶ï¼ŒåŠæ—¶è·Ÿè¿›é«˜é£é™©å®¢æˆ·ã€‚`
                });
            }

            if (intentionARate > 40) {
                insights.push({
                    type: 'success',
                    title: 'ç»­ä¿æ„å‘ç§¯æ',
                    content: `æ‰¿è¯ºç¼´è´¹å æ¯”è¾¾åˆ°${intentionARate}%ï¼Œè¯´æ˜å®¢æˆ·ç»­ä¿æ„æ„¿è¾ƒå¼ºï¼Œè½¬åŒ–æ•ˆæœè‰¯å¥½ã€‚`
                });
            } else if (intentionDRate > 40) {
                insights.push({
                    type: 'danger',
                    title: 'ç»­ä¿æ„å‘æ¶ˆæ',
                    content: `æ˜ç¡®æ‹’ç¼´å æ¯”è¾¾åˆ°${intentionDRate}%ï¼Œéœ€è¦åˆ†ææ‹’ç¼´åŸå› ï¼Œä¼˜åŒ–äº§å“å’ŒæœåŠ¡ã€‚`
                });
            }

            const topReason = Object.entries(reasonData).sort((a, b) => b[1] - a[1])[0];
            if (topReason) {
                insights.push({
                    type: 'warning',
                    title: `ä¸»è¦å½’å› ï¼š${topReason[0]}`,
                    content: `å æ¯”${(topReason[1] / total * 100).toFixed(1)}%ï¼Œå»ºè®®é’ˆå¯¹æ­¤é—®é¢˜åˆ¶å®šä¸“é¡¹è§£å†³æ–¹æ¡ˆã€‚`
                });
            }

            document.getElementById('insightsContainer').innerHTML = insights.map(insight => `
                <div class="insight-box">
                    <h4>${insight.title}</h4>
                    <p>${insight.content}</p>
                </div>
            `).join('');
        }

        function generateRecommendations(results, sentimentData, intentionData, reasonData, riskData) {
            const total = results.length;
            const recommendations = [];

            const positiveRate = (sentimentData['ç§¯æ'] || 0) / total;
            const angryRate = (sentimentData['æ„¤æ€’'] || 0) / total;
            const highRiskRate = (riskData['é«˜'] || 0) / total;
            const intentionARate = (intentionData['Aç±»-æ‰¿è¯ºç¼´è´¹'] || 0) / total;
            const intentionBRate = (intentionData['Bç±»-éœ€ååŠ©'] || 0) / total;
            const intentionCRate = (intentionData['Cç±»-æ‘‡æ‘†ä¸å®š'] || 0) / total;
            const intentionDRate = (intentionData['Dç±»-æ˜ç¡®æ‹’ç¼´'] || 0) / total;

            if (positiveRate < 0.3) {
                recommendations.push({
                    type: 'danger',
                    title: 'ä¼˜åŒ–æœåŠ¡æµç¨‹',
                    content: 'å®¢æˆ·æ»¡æ„åº¦åä½ï¼Œå»ºè®®ï¼š1ï¼‰ä¼˜åŒ–è¯æœ¯ï¼Œæå‡æœåŠ¡ä¸“ä¸šæ€§ï¼›2ï¼‰åŠ å¼ºå®¢æœåŸ¹è®­ï¼Œæé«˜æ²Ÿé€šæŠ€å·§ï¼›3ï¼‰å»ºç«‹å®¢æˆ·åé¦ˆæœºåˆ¶ï¼ŒåŠæ—¶æ”¹è¿›æœåŠ¡ã€‚'
                });
            }

            if (angryRate > 0.05) {
                recommendations.push({
                    type: 'danger',
                    title: 'å»ºç«‹æŠ•è¯‰é¢„è­¦æœºåˆ¶',
                    content: 'æ„¤æ€’æƒ…ç»ªå®¢æˆ·è¾ƒå¤šï¼Œå»ºè®®ï¼š1ï¼‰å»ºç«‹å®æ—¶æƒ…ç»ªç›‘æµ‹ç³»ç»Ÿï¼›2ï¼‰å¯¹é«˜é£é™©å®¢æˆ·è¿›è¡Œä¼˜å…ˆè·Ÿè¿›ï¼›3ï¼‰å»ºç«‹æŠ•è¯‰å¿«é€Ÿå“åº”æœºåˆ¶ï¼›4ï¼‰å®šæœŸåˆ†ææŠ•è¯‰åŸå› ï¼ŒæŒç»­æ”¹è¿›ã€‚'
                });
            }

            if (highRiskRate > 0.03) {
                recommendations.push({
                    type: 'danger',
                    title: 'åŠ å¼ºé£é™©ç®¡æ§',
                    content: 'é«˜é£é™©å®¢æˆ·å æ¯”é«˜ï¼Œå»ºè®®ï¼š1ï¼‰å»ºç«‹å®¢æˆ·é£é™©åˆ†çº§ä½“ç³»ï¼›2ï¼‰å¯¹é«˜é£é™©å®¢æˆ·è¿›è¡Œä¸€å¯¹ä¸€è·Ÿè¿›ï¼›3ï¼‰å‡†å¤‡åº”æ€¥é¢„æ¡ˆï¼Œåº”å¯¹å¯èƒ½çš„æŠ•è¯‰å’Œçº çº·ï¼›4ï¼‰å®šæœŸè¿›è¡Œé£é™©è¯„ä¼°ï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥ã€‚'
                });
            }

            if (intentionARate > 0.4) {
                recommendations.push({
                    type: 'success',
                    title: 'ä¼˜åŒ–ç¼´è´¹æµç¨‹',
                    content: 'ç»­ä¿æ„å‘ç§¯æï¼Œå»ºè®®ï¼š1ï¼‰ç®€åŒ–ç¼´è´¹æµç¨‹ï¼Œå‡å°‘æ“ä½œæ­¥éª¤ï¼›2ï¼‰æä¾›å¤šç§ç¼´è´¹æ–¹å¼ï¼Œæå‡ä¾¿åˆ©æ€§ï¼›3ï¼‰å‘é€ç¼´è´¹æé†’ï¼Œé¿å…é—å¿˜ï¼›4ï¼‰å»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶ï¼ŒåŠæ—¶è§£ç­”ç¼´è´¹é—®é¢˜ã€‚'
                });
            }

            if (intentionBRate > 0.15) {
                recommendations.push({
                    type: 'warning',
                    title: 'æä¾›æ“ä½œæŒ‡å¯¼',
                    content: 'éœ€è¦ååŠ©çš„å®¢æˆ·è¾ƒå¤šï¼Œå»ºè®®ï¼š1ï¼‰åˆ¶ä½œè¯¦ç»†çš„ç¼´è´¹æ“ä½œæŒ‡å—ï¼›2ï¼‰æä¾›è§†é¢‘æ•™ç¨‹ï¼Œé™ä½å­¦ä¹ æˆæœ¬ï¼›3ï¼‰å»ºç«‹åœ¨çº¿å®¢æœæ”¯æŒï¼Œå®æ—¶è§£ç­”æ“ä½œé—®é¢˜ï¼›4ï¼‰ä¼˜åŒ–APP/ç½‘ç«™ç•Œé¢ï¼Œæå‡æ˜“ç”¨æ€§ã€‚'
                });
            }

            if (intentionCRate > 0.3) {
                recommendations.push({
                    type: 'warning',
                    title: 'åŠ å¼ºäº§å“ä»·å€¼ä¼ è¾¾',
                    content: 'æ‘‡æ‘†ä¸å®šå®¢æˆ·è¾ƒå¤šï¼Œå»ºè®®ï¼š1ï¼‰ä¼˜åŒ–è¯æœ¯ï¼Œçªå‡ºäº§å“æ ¸å¿ƒä»·å€¼ï¼›2ï¼‰æä¾›ä¸ªæ€§åŒ–æ¨èï¼ŒåŒ¹é…å®¢æˆ·éœ€æ±‚ï¼›3ï¼‰å»ºç«‹è·Ÿè¿›æœºåˆ¶ï¼Œå®šæœŸå›è®¿ï¼›4ï¼‰æä¾›ä¼˜æƒ æ´»åŠ¨ï¼Œä¿ƒè¿›å†³ç­–ã€‚'
                });
            }

            if (intentionDRate > 0.3) {
                recommendations.push({
                    type: 'danger',
                    title: 'æ·±å…¥åˆ†ææ‹’ç¼´åŸå› ',
                    content: 'æ˜ç¡®æ‹’ç¼´å®¢æˆ·è¾ƒå¤šï¼Œå»ºè®®ï¼š1ï¼‰åˆ†ææ‹’ç¼´åŸå› åˆ†å¸ƒï¼Œæ‰¾å‡ºæ ¸å¿ƒé—®é¢˜ï¼›2ï¼‰é’ˆå¯¹ä¸»è¦é—®é¢˜åˆ¶å®šæ”¹è¿›æ–¹æ¡ˆï¼›3ï¼‰ä¼˜åŒ–äº§å“å’ŒæœåŠ¡ï¼Œæå‡ç«äº‰åŠ›ï¼›4ï¼‰å»ºç«‹å®¢æˆ·æŒ½å›æœºåˆ¶ï¼Œå°è¯•äºŒæ¬¡æ²Ÿé€šã€‚'
                });
            }

            if (reasonData['ç»æµå‹åŠ›'] / total > 0.2) {
                recommendations.push({
                    type: 'warning',
                    title: 'æä¾›çµæ´»ç¼´è´¹æ–¹æ¡ˆ',
                    content: 'ç»æµå‹åŠ›æ˜¯ä¸»è¦å½’å› ï¼Œå»ºè®®ï¼š1ï¼‰æä¾›åˆ†æœŸç¼´è´¹é€‰é¡¹ï¼›2ï¼‰æ¨å‡ºçµæ´»çš„ç¼´è´¹å‘¨æœŸï¼›3ï¼‰é’ˆå¯¹å›°éš¾å®¢æˆ·æä¾›å»¶æœŸæ”¿ç­–ï¼›4ï¼‰æä¾›ä¼˜æƒ æ´»åŠ¨ï¼Œé™ä½ç¼´è´¹é—¨æ§›ã€‚'
                });
            }

            if (reasonData['äº§å“ä¸æ»¡'] / total > 0.15) {
                recommendations.push({
                    type: 'danger',
                    title: 'ä¼˜åŒ–äº§å“è®¾è®¡',
                    content: 'äº§å“ä¸æ»¡å æ¯”è¾ƒé«˜ï¼Œå»ºè®®ï¼š1ï¼‰æ·±å…¥åˆ†æäº§å“ä¸è¶³ï¼›2ï¼‰ä¼˜åŒ–äº§å“åŠŸèƒ½å’Œæ”¶ç›Šï¼›3ï¼‰åŠ å¼ºäº§å“ä»·å€¼ä¼ è¾¾ï¼›4ï¼‰æä¾›ä¸ªæ€§åŒ–äº§å“æ–¹æ¡ˆã€‚'
                });
            }

            if (reasonData['æœåŠ¡ä¸æ»¡'] / total > 0.1) {
                recommendations.push({
                    type: 'danger',
                    title: 'æå‡æœåŠ¡è´¨é‡',
                    content: 'æœåŠ¡ä¸æ»¡å æ¯”è¾ƒé«˜ï¼Œå»ºè®®ï¼š1ï¼‰åŠ å¼ºå®¢æœåŸ¹è®­ï¼›2ï¼‰ä¼˜åŒ–æœåŠ¡æµç¨‹ï¼›3ï¼‰å»ºç«‹æœåŠ¡æ ‡å‡†ï¼›4ï¼‰åŠ å¼ºæœåŠ¡ç›‘ç£å’Œè€ƒæ ¸ã€‚'
                });
            }

            if (reasonData['æ“ä½œéšœç¢'] / total > 0.1) {
                recommendations.push({
                    type: 'warning',
                    title: 'ç®€åŒ–æ“ä½œæµç¨‹',
                    content: 'æ“ä½œéšœç¢å æ¯”è¾ƒé«˜ï¼Œå»ºè®®ï¼š1ï¼‰ç®€åŒ–ç¼´è´¹æµç¨‹ï¼›2ï¼‰ä¼˜åŒ–APP/ç½‘ç«™ç•Œé¢ï¼›3ï¼‰æä¾›æ“ä½œæŒ‡å¯¼ï¼›4ï¼‰å»ºç«‹æŠ€æœ¯æ”¯æŒå›¢é˜Ÿã€‚'
                });
            }

            if (reasonData['ç«å“æµå¤±'] / total > 0.1) {
                recommendations.push({
                    type: 'danger',
                    title: 'æå‡äº§å“ç«äº‰åŠ›',
                    content: 'ç«å“æµå¤±å æ¯”è¾ƒé«˜ï¼Œå»ºè®®ï¼š1ï¼‰åˆ†æç«å“ä¼˜åŠ¿ï¼›2ï¼‰ä¼˜åŒ–äº§å“å’ŒæœåŠ¡ï¼›3ï¼‰çªå‡ºå·®å¼‚åŒ–ä¼˜åŠ¿ï¼›4ï¼‰æä¾›ä¸“å±ä¼˜æƒ æ´»åŠ¨ã€‚'
                });
            }

            if (reasonData['ä¿¡æ¯è§¦è¾¾'] / total > 0.1) {
                recommendations.push({
                    type: 'warning',
                    title: 'åŠ å¼ºä¿¡æ¯è§¦è¾¾',
                    content: 'ä¿¡æ¯è§¦è¾¾ä¸è¶³ï¼Œå»ºè®®ï¼š1ï¼‰ä¼˜åŒ–æé†’æœºåˆ¶ï¼›2ï¼‰å¤šæ¸ é“è§¦è¾¾å®¢æˆ·ï¼›3ï¼‰æä¾›æ¸…æ™°çš„ä¿¡æ¯è¯´æ˜ï¼›4ï¼‰å»ºç«‹ä¿¡æ¯ç¡®è®¤æœºåˆ¶ã€‚'
                });
            }

            document.getElementById('recommendationsContainer').innerHTML = recommendations.map(rec => `
                <li class="recommendation-item ${rec.type}">
                    <h4>${rec.title}</h4>
                    <p>${rec.content}</p>
                </li>
            `).join('');
        }

        function getSentimentClass(sentiment) {
            const classes = {
                'ç§¯æ': 'tag-positive',
                'å¹³æ·¡': 'tag-neutral',
                'çŠ¹è±«': 'tag-hesitant',
                'ä¸è€çƒ¦': 'tag-impatient',
                'æ„¤æ€’': 'tag-angry'
            };
            return classes[sentiment] || 'tag-neutral';
        }

        function getIntentionClass(intention) {
            const classes = {
                'Aç±»-æ‰¿è¯ºç¼´è´¹': 'tag-intention-a',
                'Bç±»-éœ€ååŠ©': 'tag-intention-b',
                'Cç±»-æ‘‡æ‘†ä¸å®š': 'tag-intention-c',
                'Dç±»-æ˜ç¡®æ‹’ç¼´': 'tag-intention-d',
                'Eç±»-æ— æ•ˆ/éæœ¬äºº': 'tag-intention-e'
            };
            return classes[intention] || 'tag-neutral';
        }

        function getRiskClass(risk) {
            return risk === 'é«˜' ? 'tag-risk-high' : 'tag-risk-low';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        function hideError() {
            errorMessage.classList.remove('show');
        }

        downloadCsvBtn.addEventListener('click', () => {
            downloadCSV(currentResults);
        });

        downloadExcelBtn.addEventListener('click', () => {
            downloadExcel(currentResults);
        });

        downloadReportBtn.addEventListener('click', () => {
            downloadReport();
        });

        function downloadCSV(data) {
            const headers = ['å•å·', 'æƒ…ç»ªæ€åº¦', 'ç»­ä¿æ„å‘', 'æ ¸å¿ƒå½’å› ', 'é£é™©é¢„è­¦', 'ä¸€å¥è¯æ‘˜è¦'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'æ ‡æ³¨ç»“æœ.csv';
            link.click();
        }

        function downloadExcel(data) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ ‡æ³¨ç»“æœ');
            XLSX.writeFile(wb, 'æ ‡æ³¨ç»“æœ.xlsx');
        }

        function downloadReport() {
            const reportElement = document.getElementById('reportSection');
            
            html2canvas(reportElement, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('è¯Šæ–­æŠ¥å‘Š.pdf');
            });
        }

        loadConfig();
    </script>
</body>
</html>
